<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>成本计算器｜尺寸推成本 / 重量推成本 / 成本推倍数</title>
<style>
  :root{
    --bg:#f5f7fb;--card:#ffffff;--muted:#5b6b82;--text:#0f172a;--accent:#2563eb;--line:#e5e7eb;--shadow:0 8px 24px rgba(2,6,23,.12)
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.45 system-ui,Segoe UI,Helvetica,Arial;background:var(--bg);color:var(--text)}

  /* 顶部栏 + 右上角目录 */
  header{position:sticky;top:0;z-index:60;display:flex;align-items:center;justify-content:space-between;
    padding:14px 18px;border-bottom:1px solid var(--line);background:#fff}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .sub{color:#64748b;font-size:12px}
  .head-left{display:flex;flex-direction:column;gap:4px}
  .head-right{position:relative}
  .menu-btn{background:#fff;border:1px solid #c7d2fe;color:#1e3a8a;padding:8px 12px;border-radius:10px;cursor:pointer}
  .menu-btn:hover{filter:brightness(1.03)}
  .menu-panel{
    position:absolute; right:0; top:44px; width:240px; display:none;
    background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow); overflow:hidden
  }
  .menu-panel.show{display:block}
  .menu-item{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer}
  .menu-item:hover{background:#f8fafc}
  .menu-item .tag{font-size:11px;color:#64748b;margin-left:auto}

  .wrap{max-width:1200px;margin:0 auto;padding:14px}

  /* 全局参数吸顶栏 */
  #globalBar{
    position:sticky; top:64px; z-index:50;
    display:flex; gap:6px; flex-wrap:wrap;
    margin:8px 0 10px; padding:4px;
    background:#F6F9FFCC; border:1px solid #dbe6ff; border-radius:10px;
    align-items:center; justify-content:flex-start;
    box-shadow:0 2px 8px rgba(2,6,23,.06); backdrop-filter:saturate(1.15) blur(2px);
  }
  .tool{background:#ffffff;border:1.5px solid #94a3b8;padding:4px 6px;border-radius:14px;display:flex;align-items:center;gap:4px}
  .tool label{color:#0f172a;font-size:14px;font-weight:600;white-space:nowrap}
  input, select{
    background:#fff;border:1.5px solid #94a3b8;color:var(--text);
    padding:3px 5px;border-radius:14px;outline:none;min-width:48px;
    font-size:14px;font-weight:500;text-align:center
  }
  input:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 3px #2563eb22}

  /* 页签 */
  .tabs{display:flex;gap:8px;margin-top:6px;margin-bottom:10px}
  .tabs button{background:#fff;border:1px solid #dbe6ff;border-bottom:2px solid transparent;padding:8px 12px;border-radius:8px;cursor:pointer;color:#1e3a8a}
  .tabs button.active{border-color:#2563eb;background:#eef4ff;color:#0f172a;font-weight:700}
  .sheet{display:none}
  .sheet.is-active{display:block}

  /* Sheet 内部工具栏（按钮行） */
  .toolbar.actions{
    display:flex; gap:10px; flex-wrap:wrap;
    background:#F6F9FF; border:1px solid #dbe6ff; border-radius:10px;
    padding:6px; margin:6px 0 10px; justify-content:flex-start
  }

  button{background:var(--accent);border:1px solid #1e40af;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  button.secondary{background:#eef2ff;color:#1e40af;border-color:#c7d2fe}
  button.ghost{background:#fff;color:#1e3a8a;border-color:var(--line)}
  button:hover{filter:brightness(1.03)}

  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  thead th{background:#f8fafc;border-bottom:1px solid var(--line);color:#0f172a;font-weight:600;padding:8px 6px;font-size:12px;white-space:nowrap}
  tbody td{border-bottom:1px solid var(--line);padding:4px 6px}
  tbody tr:last-child td{border-bottom:none}
  .num{text-align:right}
  tfoot td{padding:10px;border-top:1px solid var(--line);background:#f8fafc}
  .row-actions{display:flex;gap:6px}
  .nowrap{white-space:nowrap}
  td input, td select{min-width:60px;width:90px;transition:border-color .15s ease, box-shadow .15s ease}
  td.wide input{width:110px}

  /* 视觉分组：输入 vs 计算 */
  .group-input{background:#FCFEFF}
  .group-calc{background:#F8FAFC}
  .vol, .weight, .cost, .ex{background:#F1F5F9}
  td input:hover, td select:hover{border-color:var(--accent);box-shadow:0 0 0 3px #2563eb22}

  /* 合计/总额条 */
  .totalbar{
    margin:12px 0 6px;padding:10px 12px;background:#fff;
    border:1px solid #dbe6ff;border-radius:10px;font-size:20px;font-weight:700;color:#0f172a
  }
  .totalbar .currency{font-weight:600;color:#2563eb}
  .hint{color:#475569;font-size:12px}

  /* 圆周长计算器（弹窗） */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.35);z-index:70}
  .modal.show{display:grid}
  .card{width:min(560px,90vw);background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:14px}
  .card h3{margin:0 0 10px 0;font-size:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{display:flex;align-items:center;gap:6px}
  .row label{min-width:86px;text-align:right}
  .big{font-size:22px;font-weight:800;color:#0f172a}
  .close-x{background:#fff;color:#1e293b;border:1px solid var(--line);padding:4px 8px;border-radius:10px}
  .card .foot{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
  <header>
    <div class="head-left">
      <h1>成本计算器（尺寸推成本 / 重量推成本 / 成本推倍数）</h1>
      <div class="sub">体积单位 <b>cm³</b>（按 mm 尺寸计算后 ÷1000），密度默认 <b>7.85 g/cm³</b>（可编辑）。</div>
    </div>
    <div class="head-right">
      <button id="menuBtn" class="menu-btn">目录 ▾</button>
      <div id="menuPanel" class="menu-panel">
        <div class="menu-item" data-go="sheet-cost">成本计算器<span class="tag">Sheet A/B/C</span></div>
        <div class="menu-item" id="openCirc">圆周长计算器<span class="tag">π·d</span></div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- 全局顶部参数（三张 Sheet 共用） -->
    <div id="globalBar">
      <div class="tool"><label for="density">密度(g/cm³)</label><input id="density" type="number" step="0.01" min="0" value="7.85"></div>
      <div class="tool"><label for="priceLine">线 单价(元/kg)</label><input id="priceLine" type="number" step="0.01" min="0" value="5"></div>
      <div class="tool"><label for="pricePipe">管 单价(元/kg)</label><input id="pricePipe" type="number" step="0.01" min="0" value="7"></div>
      <div class="tool"><label for="defaultMult">默认倍数</label><input id="defaultMult" type="number" step="0.1" min="0" value="3"></div>
    </div>

    <!-- 页签 -->
    <div class="tabs">
      <button id="tab-cost" class="active">Sheet A · 尺寸推成本</button>
      <button id="tab-weight">Sheet B · 重量推成本</button>
      <button id="tab-alt">Sheet C · 成本推倍数</button>
    </div>

    <!-- Sheet A：尺寸推成本 -->
    <div id="sheet-cost" class="sheet is-active">
      <div class="toolbar actions">
        <button id="addRow">+ 新增一行</button>
        <button id="exportCsv" class="secondary">导出 CSV（Excel 可打开）</button>
        <button id="reset" class="ghost">清空表格</button>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>类型</th>
            <th class="nowrap">长 / mm</th>
            <th class="nowrap">线径 / 管宽1 / mm</th>
            <th class="nowrap">管宽2 / mm <span class="hint">（方管第二边，线/圆管可留空）</span></th>
            <th class="nowrap">壁厚 / mm</th>
            <th class="nowrap">数量 / pc</th>
            <th class="nowrap">体积 / cm³</th>
            <th class="nowrap">重量 / kg</th>
            <th class="nowrap">成本(元)</th>
            <th>倍数</th>
            <th class="nowrap">出厂价(元)</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
        <tfoot>
          <tr>
            <td colspan="7" class="hint">合计</td>
            <td class="num" id="sumWeight">0.00</td>
            <td class="num" id="sumCost">0.00</td>
            <td></td>
            <td class="num" id="sumEx">0.00</td>
            <td><button id="copyAll" class="secondary">复制全部到 Excel</button></td>
          </tr>
        </tfoot>
      </table>

      <div class="totalbar">总出厂价合计：<span class="currency">¥</span> <span id="grandEx">0.00</span></div>

      <p class="hint" style="margin-top:10px">说明：
        <br>• <b>线（实心圆）</b>：需填写 <b>长、线径、数量</b>
        <br>• <b>圆管</b>：需填写 <b>长、管宽1、壁厚、数量</b>
        <br>• <b>方管</b>：需填写 <b>长、管宽1、管宽2、壁厚、数量</b>
      </p>
    </div>

    <!-- Sheet B：重量推成本 -->
    <div id="sheet-weight" class="sheet">
      <div class="toolbar actions">
        <button id="addRowC">+ 新增一行</button>
        <button id="exportCsvC" class="secondary">导出 CSV（Excel 可打开）</button>
        <button id="resetC" class="ghost">清空表格</button>
      </div>

      <table id="tblC">
        <thead>
          <tr>
            <th>类型</th>
            <th class="nowrap">重量 / kg</th>
            <th class="nowrap">数量 / pc</th>
            <th class="nowrap">成本(元)</th>
            <th class="nowrap">倍数（默认3）</th>
            <th class="nowrap">出厂价(元)</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="bodyC"></tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="hint">合计</td>
            <td class="num" id="sumCostC">0.00</td>
            <td></td>
            <td class="num" id="sumExC">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="totalbar">总出厂价合计：<span class="currency">¥</span> <span id="grandExC">0.00</span></div>

      <p class="hint" style="margin-top:10px">
        说明（重量推成本）：成本 = 重量 × 数量 × 单价（线用“线 单价(元/kg)”，圆管/方管用“管 单价(元/kg)”）；出厂价 = 成本 × 倍数（未填写则使用“默认倍数”）。
      </p>
    </div>

    <!-- Sheet C：成本推倍数 -->
    <div id="sheet-alt" class="sheet">
      <div class="toolbar actions">
        <button id="addRowB">+ 新增一行</button>
        <button id="exportCsvB" class="secondary">导出 CSV（Excel 可打开）</button>
        <button id="resetB" class="ghost">清空表格</button>
      </div>

      <table id="tblB">
        <thead>
          <tr>
            <th>类型</th>
            <th class="nowrap">重量 / kg</th>
            <th class="nowrap">数量 / pc</th>
            <th class="nowrap">出厂价(元)</th>
            <th class="nowrap">倍数（反推）</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="bodyB"></tbody>
      </table>

      <div class="totalbar">平均倍数：<span id="sumMultB">0.00</span></div>

      <p class="hint" style="margin-top:10px">说明（成本推倍数）：倍数 = 出厂价 ÷ （重量 × 数量 × 单价）。其中：线使用“线 单价(元/kg)”，圆管/方管使用“管 单价(元/kg)”。</p>
    </div>
  </div>

  <!-- 圆周长计算器 Modal -->
  <div id="circModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="circTitle">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h3 id="circTitle">圆周长计算器（C = π × d）</h3>
        <button id="closeCirc" class="close-x">关闭</button>
      </div>
      <div class="grid" style="margin-bottom:10px">
        <div class="row">
          <label for="diameter">直径</label>
          <input id="diameter" type="number" step="0.01" min="0" placeholder="输入直径">
        </div>
        <div class="row">
          <label for="unit">单位</label>
          <select id="unit">
            <option value="mm">mm（毫米）</option>
            <option value="cm">cm（厘米）</option>
            <option value="m">m（米）</option>
          </select>
        </div>
      </div>
            <!-- 新增：线径（mm） -->
      <div class="row" style="margin-bottom:6px">
        <label for="wireDia">线径(mm)</label>
        <input id="wireDia" type="number" step="0.01" min="0" placeholder="输入线径（mm）">
      </div>
      <div class="row">
        <label>周长</label>
        <div class="big"><span id="circVal">0.00</span> <span id="circUnit">mm</span></div>
      </div>
      <div class="foot">
        <button id="copyCirc" class="secondary">复制结果</button>
        <button id="calcToA" class="ghost" title="把线径带入A表的‘线径/管宽1’">带入到尺寸推成本</button>
      </div>
    </div>
  </div>

<script>
/* ========= 共用小工具 ========= */
const $ = (s,p=document) => p.querySelector(s);
const $$ = (s,p=document) => [...p.querySelectorAll(s)];
const fmt  = n => (isFinite(n) ? Number(n).toFixed(2) : '0.00');
const fmt1 = n => (isFinite(n) ? Number(n).toFixed(1) : '0.0');
const abs  = v => Math.abs(Number(v)||0);

/* ========= 目录（右上角） ========= */
const menuBtn = $('#menuBtn');
const menuPanel = $('#menuPanel');
menuBtn.addEventListener('click', ()=>{
  menuPanel.classList.toggle('show');
});
document.addEventListener('click', (e)=>{
  if(!menuPanel.contains(e.target) && !menuBtn.contains(e.target)){
    menuPanel.classList.remove('show');
  }
});
menuPanel.querySelectorAll('.menu-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    const go = item.getAttribute('data-go');
    if(go === 'sheet-cost'){ switchSheet('sheet-cost'); }
    menuPanel.classList.remove('show');
  });
});
$('#openCirc').addEventListener('click', ()=>{
  menuPanel.classList.remove('show');
  openCircModal();
});

/* ========= 圆周长计算器 ========= */
const circModal = $('#circModal');
const diameterInput = $('#diameter');
const unitSel = $('#unit');
const circVal = $('#circVal');
const circUnit = $('#circUnit');

function openCircModal(){
  circModal.classList.add('show');
  circModal.setAttribute('aria-hidden','false');
  diameterInput.focus();
  updateCirc();
}
function closeCircModal(){
  circModal.classList.remove('show');
  circModal.setAttribute('aria-hidden','true');
}
$('#closeCirc').addEventListener('click', closeCircModal);
circModal.addEventListener('click', (e)=>{ if(e.target===circModal) closeCircModal(); });
['input','change'].forEach(ev=>{
  diameterInput.addEventListener(ev, updateCirc);
  unitSel.addEventListener(ev, updateCirc);
});
function updateCirc(){
  const d = abs(diameterInput.value);
  const u = unitSel.value;
  const C = Math.PI * d; // π * d
  circVal.textContent = fmt(C);
  circUnit.textContent = u;
  // 结束输入时：绝对值
  diameterInput.addEventListener('change', ()=>{ diameterInput.value = String(abs(diameterInput.value)); });
}
$('#copyCirc').addEventListener('click', ()=>{
  const text = `${fmt(Math.PI*abs(diameterInput.value))} ${unitSel.value}`;
  navigator.clipboard.writeText(text).then(()=>alert('已复制周长结果'));
});
$('#calcToA').addEventListener('click', ()=>{
  const dRaw = abs(diameterInput.value);   // 直径（按所选单位）
  const wRaw = abs($('#wireDia').value);   // 线径（mm）

  if(!dRaw){
    alert('请输入直径');
    return;
  }
  if(!wRaw){
    alert('请输入线径（mm）');
    return;
  }

  // 直径统一换算到 mm
  let d_mm = dRaw;
  if(unitSel.value === 'cm') d_mm = dRaw * 10;
  else if(unitSel.value === 'm') d_mm = dRaw * 1000;

  // 周长（mm）向上取整
  const C_mm = Math.ceil(Math.PI * d_mm);

  // 新行数据：类型=线，长=ceil(周长mm)，线径=输入线径mm(四舍五入)，数量=1，倍数走默认
  const init = {
    type: '线',
    len: C_mm,
    w1: Math.round(wRaw), // 线径(mm)
    w2: 0,
    t: 0,
    qty: 1,
    mult: null
  };

  const tr = rowTemplate(init);
  $('#body').appendChild(tr);
  saveAll();
  recalcTotals();

  switchSheet('sheet-cost');
  closeCircModal();
});

function ensureFirstRow(){
  if(!$('#body tr')) addRow();
}

/* ========= 页签切换 ========= */
function switchSheet(id){
  $$('.sheet').forEach(s=>s.classList.remove('is-active'));
  $$('.tabs button').forEach(b=>b.classList.remove('active'));
  let btnId = 'tab-cost';
  if(id==='sheet-weight') btnId = 'tab-weight';
  if(id==='sheet-alt') btnId = 'tab-alt';
  document.getElementById(id)?.classList.add('is-active');
  document.getElementById(btnId)?.classList.add('active');
}
document.getElementById('tab-cost').addEventListener('click',()=>switchSheet('sheet-cost'));
document.getElementById('tab-weight').addEventListener('click',()=>switchSheet('sheet-weight'));
document.getElementById('tab-alt').addEventListener('click',()=>switchSheet('sheet-alt'));

/* ========= 全局参数 ========= */
function currentDensity(){ return abs($('#density').value) || 7.85; }
function priceByType(type){
  const lineP = abs($('#priceLine').value)||0;
  const pipeP = abs($('#pricePipe').value)||0;
  return (type==='线') ? lineP : pipeP;
}

/* ========= A：尺寸推成本 ========= */
function computeVolumeCm3(type, Lmm, W1mm, W2mm, Tmm){
  const L = abs(Lmm);
  const W1 = abs(W1mm);
  const W2 = abs(W2mm);
  const T  = abs(Tmm);
  const PI = Math.PI;

  if(type==='线'){
    const r = W1/2;
    const vol_mm3 = PI * r*r * L;
    return vol_mm3/1000;
  }
  if(type==='圆管'){
    const R = W1/2; let r = R - T; if(r<0) r = 0;
    const vol_mm3 = PI * (R*R - r*r) * L;
    return vol_mm3/1000;
  }
  if(type==='方管'){
    const a = W1; const b = (W2>0?W2:W1);
    let ai = a - 2*T, bi = b - 2*T;
    if(ai<=0 || bi<=0){
      return (a*b*L)/1000;
    }
    const area_mm2 = (a*b - ai*bi);
    return (area_mm2 * L)/1000;
  }
  return 0;
}

function rowTemplate(data={}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="group-input"><select class="type">
      <option value="线">线</option>
      <option value="圆管">圆管</option>
      <option value="方管">方管</option>
    </select></td>
    <td class="group-input"><input class="len num" type="number" step="1" min="0" value="${data.len??''}" placeholder="mm"></td>
    <td class="group-input"><input class="w1 num"  type="number" step="1" min="0" value="${data.w1??''}" placeholder="线径/管宽1"></td>
    <td class="group-input"><input class="w2 num"  type="number" step="1" min="0" value="${data.w2??''}" placeholder="管宽2(方管)"></td>
    <td class="group-input"><input class="t  num"   type="number" step="0.1" min="0" value="${data.t??''}"  placeholder="壁厚"></td>
    <td class="group-input"><input class="qty num" type="number" step="1" min="0" value="${data.qty??1}"></td>
    <td class="group-calc num vol">0.00</td>
    <td class="group-calc num weight">0.00</td>
    <td class="group-calc num cost">0.00</td>
    <td class="group-input"><input class="mult num" type="number" step="0.1" min="0" value="${data.mult??''}" placeholder="默认"></td>
    <td class="group-calc num ex">0.00</td>
    <td class="row-actions">
      <button class="dup"  title="复制一行">复制</button>
      <button class="copy" title="复制到Excel" type="button">复制到Excel</button>
      <button class="del"  title="删除" type="button">删除</button>
    </td>
  `;
  tr.$ = (s)=>tr.querySelector(s);
  tr.typeSel = tr.$('.type');
  tr.len = tr.$('.len');
  tr.w1  = tr.$('.w1');
  tr.w2  = tr.$('.w2');
  tr.t   = tr.$('.t');
  tr.qty = tr.$('.qty');
  tr.mult= tr.$('.mult');
  if(data.mult==null) tr.mult.value = $('#defaultMult').value;
  tr.vol = tr.$('.vol');
  tr.weight = tr.$('.weight');
  tr.cost = tr.$('.cost');
  tr.ex   = tr.$('.ex');

  if(data.type){ tr.typeSel.value = data.type }

  // 实时重算
  [tr.typeSel,tr.len,tr.w1,tr.w2,tr.t,tr.qty,tr.mult]
    .forEach(el=>el.addEventListener('input',()=>recalcRow(tr,true)));

  // 结束输入：自动取绝对值 & 指定小数位/整数
  [tr.len,tr.w1,tr.w2,tr.qty].forEach(el=>{
    el.addEventListener('change', ()=>{
      el.value = String(Math.round(abs(el.value))); // 整数且非负
      recalcRow(tr,true);
    });
  });
  tr.t.addEventListener('change', ()=>{
    tr.t.value = fmt1(abs(tr.t.value));            // 1位小数 & 非负
    recalcRow(tr,true);
  });
  tr.mult.addEventListener('change', ()=>{
    if(tr.mult.value!==''){ tr.mult.value = fmt1(abs(tr.mult.value)); }
    recalcRow(tr,true);
  });

  tr.$('.dup').addEventListener('click',()=>{ addRow(getRowData(tr)); });
  tr.$('.del').addEventListener('click',()=>{ tr.remove(); recalcTotals(); saveAll(); });
  tr.$('.copy').addEventListener('click',()=>copyRowToClipboard(tr));

  recalcRow(tr,false);
  return tr;
}

function getRowData(tr){
  return {
    type: tr.typeSel.value,
    len:  Math.round(abs(tr.len.value)),
    w1 :  Math.round(abs(tr.w1.value)),
    w2 :  Math.round(abs(tr.w2.value)),
    t  :  abs(tr.t.value),
    qty:  Math.round(abs(tr.qty.value)||0), // 允许为 0
    mult: tr.mult.value===''? null : abs(tr.mult.value)
  }
}

function recalcRow(tr, doSave){
  const d = getRowData(tr);
  const mult = (d.mult==null ? abs($('#defaultMult').value)||1 : d.mult);

  const volPer   = computeVolumeCm3(d.type, d.len, d.w1, d.w2, d.t);
  const vol      = volPer * (d.qty||0);
  const weightKg = vol * currentDensity() / 1000;
  const unitPrice= priceByType(d.type);
  const cost     = weightKg * unitPrice;
  const ex       = (d.qty===0) ? 0 : (cost * mult);

  tr.vol.textContent    = fmt(vol);
  tr.weight.textContent = fmt(weightKg);
  tr.cost.textContent   = fmt(cost);
  tr.ex.textContent     = fmt(ex);

  if(doSave){ saveAll(); }
  recalcTotals();
}

function recalcTotals(){
  let sumW=0,sumC=0,sumE=0;
  $$('#body tr').forEach(tr=>{
    sumW += +tr.querySelector('.weight').textContent||0;
    sumC += +tr.querySelector('.cost').textContent||0;
    sumE += +tr.querySelector('.ex').textContent||0;
  });
  $('#sumWeight').textContent = fmt(sumW);
  $('#sumCost').textContent   = fmt(sumC);
  $('#sumEx').textContent     = fmt(sumE);
  const g = $('#grandEx'); if(g) g.textContent = fmt(sumE);
}

function addRow(init={}){ $('#body').appendChild(rowTemplate(init)); saveAll(); }

function copyRowToClipboard(tr){
  const d = getRowData(tr);
  const cells = [
    d.type, d.len, d.w1, d.w2, fmt1(d.t), d.qty,
    tr.querySelector('.vol').textContent,
    tr.querySelector('.weight').textContent,
    tr.querySelector('.cost').textContent,
    fmt1(d.mult==null ? abs($('#defaultMult').value) : d.mult),
    tr.querySelector('.ex').textContent
  ];
  navigator.clipboard.writeText(cells.join('\t')).then(()=>alert('已复制当前行，直接粘贴到 Excel 即可'));
}

function exportCsv(){
  const header = ['类型','长(mm)','线径/管宽1(mm)','管宽2(mm)','壁厚(mm)','数量(pc)','体积(cm3)','重量(kg)','成本(元)','倍数','出厂价(元)'];
  const rows = $$('#body tr').map(tr=>{
    const d = getRowData(tr);
    return [
      d.type, d.len, d.w1, d.w2, fmt1(d.t), d.qty,
      tr.querySelector('.vol').textContent,
      tr.querySelector('.weight').textContent,
      tr.querySelector('.cost').textContent,
      fmt1(d.mult==null ? abs($('#defaultMult').value) : d.mult),
      tr.querySelector('.ex').textContent
    ];
  });
  const all = [header, ...rows];
  const csv = all.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '尺寸推成本-导出.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

function copyAllToClipboard(){
  const header = ['类型','长(mm)','线径/管宽1(mm)','管宽2(mm)','壁厚(mm)','数量(pc)','体积(cm3)','重量(kg)','成本(元)','倍数','出厂价(元)'];
  const rows = $$('#body tr').map(tr=>{
    const d = getRowData(tr);
    return [
      d.type, d.len, d.w1, d.w2, fmt1(d.t), d.qty,
      tr.querySelector('.vol').textContent,
      tr.querySelector('.weight').textContent,
      tr.querySelector('.cost').textContent,
      fmt1(d.mult==null ? abs($('#defaultMult').value) : d.mult),
      tr.querySelector('.ex').textContent
    ];
  });
  const text = [header, ...rows].map(r=>r.join('\t')).join('\n');
  navigator.clipboard.writeText(text).then(()=>alert('✅ 已复制整表内容，可直接粘贴到 Excel'));
}

/* ========= B：重量推成本 ========= */
function rowTemplateC(data={}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="group-input"><select class="typeC">
      <option value="线">线</option>
      <option value="圆管">圆管</option>
      <option value="方管">方管</option>
    </select></td>
    <td class="group-input"><input class="wkgC num" type="number" step="0.01" min="0" value="${data.wkg??''}" placeholder="重量kg"></td>
    <td class="group-input"><input class="qtyC num" type="number" step="1" min="0" value="${data.qty??1}"></td>
    <td class="group-calc num costC">0.00</td>
    <td class="group-input"><input class="multC num" type="number" step="0.1" min="0" value="${data.mult??''}" placeholder="默认"></td>
    <td class="group-calc num exC">0.00</td>
    <td class="row-actions">
      <button class="dupC"  title="复制一行">复制</button>
      <button class="delC"  title="删除" type="button">删除</button>
    </td>
  `;
  tr.$ = s => tr.querySelector(s);
  tr.typeSel = tr.$('.typeC');
  tr.wkg = tr.$('.wkgC');
  tr.qty = tr.$('.qtyC');
  tr.mult = tr.$('.multC');
  tr.costCell = tr.$('.costC');
  tr.exCell = tr.$('.exC');

  if(data.type){ tr.typeSel.value = data.type; }
  if(data.mult==null) tr.mult.value = $('#defaultMult').value;

  [tr.typeSel, tr.wkg, tr.qty, tr.mult].forEach(el => el.addEventListener('input', ()=>recalcRowC(tr,true)));

  // 结束输入：取绝对值；数量为整数；倍数保留1位
  tr.wkg.addEventListener('change', ()=>{ tr.wkg.value = String(abs(tr.wkg.value)); recalcRowC(tr,true); });
  tr.qty.addEventListener('change', ()=>{ tr.qty.value = String(Math.round(abs(tr.qty.value))); recalcRowC(tr,true); });
  tr.mult.addEventListener('change', ()=>{ if(tr.mult.value!==''){ tr.mult.value = fmt1(abs(tr.mult.value)); } recalcRowC(tr,true); });

  tr.$('.dupC').addEventListener('click', ()=>{ addRowC(getRowDataC(tr)); });
  tr.$('.delC').addEventListener('click', ()=>{ tr.remove(); saveAll(); recalcTotalsC(); });

  recalcRowC(tr,false);
  return tr;
}

function getRowDataC(tr){
  return {
    type: tr.typeSel.value,
    wkg : abs(tr.wkg.value),
    qty : Math.round(abs(tr.qty.value)||0), // 可为 0
    mult: tr.mult.value===''? null : abs(tr.mult.value)
  };
}

function recalcRowC(tr, doSave){
  const d = getRowDataC(tr);
  const unit = priceByType(d.type);
  const cost = (d.wkg||0) * (d.qty||0) * (unit||0);
  const mult = (d.mult==null ? abs($('#defaultMult').value)||1 : d.mult);
  const ex = (d.qty===0) ? 0 : (cost * mult);

  tr.costCell.textContent = fmt(cost);
  tr.exCell.textContent   = fmt(ex);

  if(doSave) saveAll();
  recalcTotalsC();
}

function addRowC(init={}){ $('#bodyC').appendChild(rowTemplateC(init)); saveAll(); recalcTotalsC(); }

function exportCsvC(){
  const header = ['类型','重量(kg)','数量(pc)','成本(元)','倍数','出厂价(元)'];
  const rows = $$('#bodyC tr').map(tr=>{
    const d = getRowDataC(tr);
    return [
      d.type, d.wkg, d.qty,
      tr.querySelector('.costC').textContent,
      fmt1(d.mult==null ? abs($('#defaultMult').value) : d.mult),
      tr.querySelector('.exC').textContent
    ];
  });
  const csv = [header, ...rows].map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '重量推成本-导出.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

function recalcTotalsC(){
  let sumCost=0, sumEx=0;
  $$('#bodyC tr').forEach(tr=>{
    sumCost += +tr.querySelector('.costC').textContent || 0;
    sumEx   += +tr.querySelector('.exC').textContent   || 0;
  });
  $('#sumCostC').textContent = fmt(sumCost);
  $('#sumExC').textContent   = fmt(sumEx);
  const g = $('#grandExC'); if(g) g.textContent = fmt(sumEx);
}

/* ========= C：成本推倍数 ========= */
function priceByTypeB(type){ return priceByType(type); }

function rowTemplateB(data={}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="group-input"><select class="typeB">
      <option value="线">线</option>
      <option value="圆管">圆管</option>
      <option value="方管">方管</option>
    </select></td>
    <td class="group-input"><input class="wkg num"  type="number" step="0.01" min="0" value="${data.wkg??''}" placeholder="重量kg"></td>
    <td class="group-input"><input class="qtyB num"  type="number" step="1" min="0" value="${data.qty??1}"></td>
    <td class="group-input"><input class="exB  num"  type="number" step="0.01" min="0" value="${data.ex??''}" placeholder="出厂价"></td>
    <td class="group-calc num multB">0.00</td>
    <td class="row-actions">
      <button class="dupB" title="复制一行">复制</button>
      <button class="delB" title="删除" type="button">删除</button>
    </td>
  `;
  tr.$ = (s)=>tr.querySelector(s);
  tr.typeSel = tr.$('.typeB');
  tr.wkg = tr.$('.wkg');
  tr.qty = tr.$('.qtyB');
  tr.ex  = tr.$('.exB');
  tr.multCell = tr.$('.multB');

  if(data.type){ tr.typeSel.value = data.type }

  [tr.typeSel,tr.wkg,tr.qty,tr.ex].forEach(el=>el.addEventListener('input',()=>recalcRowB(tr,true)));

  // 结束输入：全部取绝对值，数量取整数
  tr.wkg.addEventListener('change', ()=>{ tr.wkg.value = String(abs(tr.wkg.value)); recalcRowB(tr,true); });
  tr.qty.addEventListener('change', ()=>{ tr.qty.value = String(Math.round(abs(tr.qty.value))); recalcRowB(tr,true); });
  tr.ex .addEventListener('change', ()=>{ tr.ex.value  = String(abs(tr.ex.value));  recalcRowB(tr,true); });

  tr.$('.dupB').addEventListener('click',()=>{ addRowB(getRowDataB(tr)); });
  tr.$('.delB').addEventListener('click',()=>{ tr.remove(); saveAll(); recalcTotalsB(); });

  recalcRowB(tr,false);
  return tr;
}

function getRowDataB(tr){
  return {
    type: tr.typeSel.value,
    wkg: abs(tr.wkg.value),
    qty: Math.round(abs(tr.qty.value)||0), // 可为 0
    ex : abs(tr.ex.value)
  }
}

function recalcRowB(tr, doSave){
  const d = getRowDataB(tr);
  const unit = priceByTypeB(d.type);
  const denom = (d.wkg||0) * (d.qty||0) * (unit||0);
  const mult = denom>0 ? (d.ex||0)/denom : 0;
  tr.multCell.textContent = fmt(mult);
  if(doSave) saveAll();
  recalcTotalsB();
}

function addRowB(init={}){ $('#bodyB').appendChild(rowTemplateB(init)); saveAll(); recalcTotalsB(); }

function recalcTotalsB(){
  const cells = $$('#bodyB .multB');
  let sum = 0, n = 0;
  cells.forEach(c=>{ const v = +c.textContent; if(isFinite(v) && v>0){ sum += v; n++; } });
  const avg = n ? sum / n : 0;
  const el = $('#sumMultB'); if(el) el.textContent = fmt(avg);
}

function exportCsvB(){
  const header = ['类型','重量(kg)','数量(pc)','出厂价(元)','倍数(反推)'];
  const rows = $$('#bodyB tr').map(tr=>{
    const d = getRowDataB(tr);
    return [d.type, d.wkg, d.qty, d.ex, tr.querySelector('.multB').textContent];
  });
  const csv = [header, ...rows].map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '成本推倍数-导出.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= 存储（A+B+C+全局参数） ========= */
const STORAGE_KEY = 'cost-calc-v3';

function saveAll(){
  const rowsA = $$('#body tr').map(tr=>getRowData(tr));
  const rowsB = $$('#bodyC tr').map(tr=>getRowDataC(tr));
  const rowsC = $$('#bodyB tr').map(tr=>getRowDataB(tr));
  const state = {
    defaults:{
      density:abs($('#density').value)||7.85,
      priceLine:abs($('#priceLine').value)||5,
      pricePipe:abs($('#pricePipe').value)||7,
      mult:abs($('#defaultMult').value)||3
    },
    rowsA, rowsB, rowsC
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadAll(){
  const s = localStorage.getItem(STORAGE_KEY);
  if(!s) return false;
  try{
    const st = JSON.parse(s);
    if(st?.defaults){
      $('#density').value    = st.defaults.density ?? 7.85;
      $('#priceLine').value  = st.defaults.priceLine ?? 5;
      $('#pricePipe').value  = st.defaults.pricePipe ?? 7;
      $('#defaultMult').value= st.defaults.mult ?? 3;
    }
    if(Array.isArray(st.rowsA)) st.rowsA.forEach(r=>addRow(r));
    if(Array.isArray(st.rowsB)) st.rowsB.forEach(r=>addRowC(r));
    if(Array.isArray(st.rowsC)) st.rowsC.forEach(r=>addRowB(r));
    recalcTotals();
    recalcTotalsC();
    recalcTotalsB();
    return true;
  }catch(e){ console.warn(e); }
  return false;
}

/* ========= 事件绑定 ========= */
$('#addRow').addEventListener('click',()=>addRow());
$('#copyAll').addEventListener('click', copyAllToClipboard);
$('#exportCsv').addEventListener('click', exportCsv);
$('#reset').addEventListener('click',()=>{
  if(confirm('确定要清空 Sheet A 吗？')){
    $('#body').innerHTML='';
    recalcTotals();
    saveAll();
  }
});
['priceLine','pricePipe','defaultMult','density'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input',()=>{
    // 全局参数变化 → 三张表都重算
    $$('#body tr').forEach(tr=>recalcRow(tr,false));   // A
    $$('#bodyC tr').forEach(tr=>recalcRowC(tr,false)); // B
    $$('#bodyB tr').forEach(tr=>recalcRowB(tr,false)); // C
    recalcTotals(); recalcTotalsC(); recalcTotalsB(); saveAll();
  });
  el.addEventListener('change', ()=>{
    el.value = (id==='defaultMult') ? fmt1(abs(el.value)) : String(abs(el.value));
    $$('#body tr').forEach(tr=>recalcRow(tr,false));
    $$('#bodyC tr').forEach(tr=>recalcRowC(tr,false));
    $$('#bodyB tr').forEach(tr=>recalcRowB(tr,false));
    recalcTotals(); recalcTotalsC(); recalcTotalsB(); saveAll();
  });
});

/* B：重量推成本 事件 */
$('#addRowC').addEventListener('click',()=>addRowC());
$('#exportCsvC').addEventListener('click',exportCsvC);
$('#resetC').addEventListener('click',()=>{
  if(confirm('确定要清空 Sheet B 吗？')){
    $('#bodyC').innerHTML = '';
    recalcTotalsC();
    saveAll();
  }
});

/* C：成本推倍数 事件 */
$('#addRowB').addEventListener('click',()=>addRowB());
$('#exportCsvB').addEventListener('click',exportCsvB);
$('#resetB').addEventListener('click',()=>{
  if(confirm('确定要清空 Sheet C 吗？')){
    $('#bodyB').innerHTML='';
    recalcTotalsB();
    saveAll();
  }
});

/* ========= 初始化 ========= */
if(!loadAll()){
  // 初次打开不预置行
}
</script>
</body>
</html>
